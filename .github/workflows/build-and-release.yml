name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  # Job 1: Build Chrome Extension
  build-extension:
    name: Build Chrome Extension
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Update manifest version
        if: github.event.inputs.version != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          jq ".version = \"$VERSION\"" extension/manifest.json > extension/manifest.json.tmp
          mv extension/manifest.json.tmp extension/manifest.json
          echo "Updated manifest.json to version $VERSION"

      - name: Verify extension structure
        run: |
          echo "Checking extension files..."
          if [ ! -f "extension/manifest.json" ]; then
            echo "Error: manifest.json not found"
            exit 1
          fi

          if [ ! -f "extension/icon-16.png" ] || [ ! -f "extension/icon-48.png" ] || [ ! -f "extension/icon-128.png" ]; then
            echo "Error: Required icon files not found"
            exit 1
          fi

          echo "Extension structure verified âœ“"

      - name: Create Chrome Web Store package
        run: |
          cd extension
          zip -r ../canvasflow-extension-v${{ steps.version.outputs.version }}.zip \
            manifest.json \
            background.js \
            content.js \
            sidepanel.html \
            sidepanel.js \
            schedule.html \
            schedule.js \
            schedule.css \
            icon-16.png \
            icon-48.png \
            icon-128.png \
            lib/ \
            types/ \
            -x "*.md" "*.DS_Store" "*node_modules*"
          cd ..

          echo "Package created: canvasflow-extension-v${{ steps.version.outputs.version }}.zip"
          ls -lh canvasflow-extension-v${{ steps.version.outputs.version }}.zip

      - name: Verify ZIP contents
        run: |
          unzip -l canvasflow-extension-v${{ steps.version.outputs.version }}.zip

          # Check file count
          FILE_COUNT=$(unzip -l canvasflow-extension-v${{ steps.version.outputs.version }}.zip | grep -c "^-")
          echo "Total files in package: $FILE_COUNT"

      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-build
          path: canvasflow-extension-v${{ steps.version.outputs.version }}.zip
          retention-days: 90

  # Job 2: Build Native Host (runs in parallel with extension build)
  build-native-host:
    name: Build Native Host
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        working-directory: ./native-host
        run: npm ci

      - name: Create distribution packages
        run: |
          mkdir -p dist
          cd native-host

          # Create ZIP package (for Chrome extension native messaging setup)
          zip -r ../dist/canvas-mcp-server-chrome-extension.zip \
            host.js \
            manifest.json \
            package.json \
            package-lock.json \
            install.sh \
            install.bat \
            README.md

          # Create DXT package (for Claude Desktop drag-and-drop)
          zip -r ../dist/canvas-mcp-server-native-host.dxt \
            host.js \
            manifest.json \
            package.json \
            package-lock.json

          # Also create versioned native host package
          zip -r ../dist/canvasflow-native-host-v${{ steps.version.outputs.version }}.zip \
            host.js \
            package.json \
            package-lock.json \
            manifest.json \
            README.md \
            -x "*.DS_Store" "*node_modules*"

          echo "Packages created:"
          ls -lh ../dist/

      - name: Upload native host artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native-host-build
          path: dist/*
          retention-days: 90

  # Job 3: Create Release (runs after both build jobs complete)
  release:
    name: Create GitHub Release
    needs: [build-extension, build-native-host]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          cp artifacts/extension-build/* release-files/
          cp artifacts/native-host-build/* release-files/
          ls -lh release-files/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.build-extension.outputs.version }}"
          cat > release-notes.md << EOF
          ## CanvasFlow v${VERSION}

          ### Chrome Extension

          **What's New:**
          - AI-powered insights using GitHub Models with structured outputs
          - Weekly schedule generation
          - Direct Canvas data extraction (no API key required)
          - MCP server integration for Claude Desktop

          **Installation:**
          1. Download \`canvasflow-extension-v${VERSION}.zip\`
          2. Extract the ZIP file
          3. Open Chrome and go to \`chrome://extensions/\`
          4. Enable "Developer mode"
          5. Click "Load unpacked" and select the extracted folder

          **For Chrome Web Store submission:**
          Use \`canvasflow-extension-v${VERSION}.zip\` directly

          ### Native Host (For MCP Integration)

          **Option 1: Claude Desktop MCP Server (Recommended)**
          1. Download \`canvas-mcp-server-native-host.dxt\`
          2. Open Claude Desktop â†’ Extensions
          3. Drag the \`.dxt\` file into the extensions area
          4. Done! Claude Desktop will handle everything automatically

          **Option 2: Chrome Extension Native Messaging**
          1. Download \`canvas-mcp-server-chrome-extension.zip\`
          2. Extract and run the installation script (\`install.sh\` or \`install.bat\`)
          3. See native-host/README.md for detailed instructions

          ---

          **Privacy Policy:** https://github.com/jonasneves/canvas-mcp-server/blob/main/PRIVACY.md
          **Documentation:** https://github.com/jonasneves/canvas-mcp-server/blob/main/README.md
          EOF

          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', needs.build-extension.outputs.version) }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && format('CanvasFlow {0}', github.ref_name) || format('CanvasFlow v{0}', needs.build-extension.outputs.version) }}
          files: release-files/*
          body_path: release-notes.md
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 4: Build Summary (runs after everything completes)
  summary:
    name: Build Summary
    needs: [build-extension, build-native-host, release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          VERSION="${{ needs.build-extension.outputs.version }}"

          echo "## ðŸ“¦ Build & Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Build Status:" >> $GITHUB_STEP_SUMMARY
          echo "- Extension Build: ${{ needs.build-extension.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Native Host Build: ${{ needs.build-native-host.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Release: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Packages Created:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Chrome Extension: \`canvasflow-extension-v${VERSION}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Native Host (Chrome): \`canvas-mcp-server-chrome-extension.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Native Host (Claude): \`canvas-mcp-server-native-host.dxt\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Native Host (Versioned): \`canvasflow-native-host-v${VERSION}.zip\`" >> $GITHUB_STEP_SUMMARY
